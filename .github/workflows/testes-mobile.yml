name: Mobile Tests CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do código
      - name: Checkout code
        uses: actions/checkout@v4

      # 3. Instalar Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 4. Instalar dependências do npm
      - name: Install npm dependencies
        run: npm install

      # 5. Configurar o Android SDK
      - name: Set up Android SDK
        uses: android-actions/setup-android@v2

      # 6. Instalar o Android Emulator
      - name: Install Android Emulator
        run: |
          sdkmanager --install "emulator"
          sdkmanager --install "system-images;android-30;google_apis;x86"
          echo "no" | avdmanager create avd -n android-emu -k "system-images;android-30;google_apis;x86" --force

      # 7. Adicionar emulador ao PATH
      - name: Add emulator to PATH
        run: |
          echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH

      # 8. Iniciar o Emulador
      - name: Start Android Emulator
        run: |
          emulator -avd android-emu -no-audio -no-window -no-snapshot -gpu swiftshader_indirect -no-accel &
          adb wait-for-device
          adb devices

      # 9. Executar os testes
      - name: Run tests
        run:  npx wdio config/wdio.conf.js --spec ./tests/home/home.test.js

      # 10. Gerar relatórios do Allure
      - name: Generate Allure Report
        run: npm run allure-report

      # 11. Publicar o relatório do Allure como artefato
      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/